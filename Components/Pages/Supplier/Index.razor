@page "/purchase/suppliers"
@using InventiCloud.Components.UI
@using InventiCloud.Services
@using InventiCloud.Services.Interface
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using InventiCloud.Entities
@using InventiCloud.Data
@inject IDbContextFactory<InventiCloud.Data.ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISupplierService SupplierService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ISnackbar Snackbar
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
<PageTitle>Index</PageTitle>

<MudText Class="bold mb-2" Typo="Typo.h4">Suppliers</MudText>
@if (_suppliers == null)
{
    <MudContainer Class="d-flex justify-center align-items-center" Style="height: 100vh;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudContainer>
}
else
{

    @if (!_suppliers.Any())
    {

        <MudPaper Height="500px" Class="justify-center align-content-center">
            <MudText Class="bol" Typo="Typo.h6" Align="Align.Center">No Suppliers Found</MudText>
            <MudText Typo="Typo.body1" Align="Align.Center">
                You don't have any suppliers yet. Click the "Add Supplier" button to get started.
            </MudText>
            <MudContainer Class="d-flex justify-center mt-2">
                <MudButton Variant="Variant.Filled"  Href="/purchase/suppliers/create" Color="Color.Primary" Class="text-uppercase">
                    Add Supplier
                </MudButton>
            </MudContainer>
        </MudPaper>        
    }

    else
    {

        <MudGrid>
            <MudItem sm="6">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudTextField T="string" ValueChanged="@(s=>OnSearch(s))" Variant="Variant.Outlined" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                    AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </MudStack>

            </MudItem>

            <MudItem sm="6" Class="d-flex justify-end">
                <AuthorizeView Roles="Administrator">
                    <MudButton Variant="Variant.Filled" Href="/purchase/suppliers/create" Color="Color.Primary" Class="text-uppercase">
                        Create Supplier
                    </MudButton>
                </AuthorizeView>
                
            </MudItem>

        </MudGrid>


        <MudDataGrid @ref="dataGrid" T="Supplier" ServerData="ServerReload" RowClick="@RowClicked">
            <Columns>
                <PropertyColumn Property="supplier => supplier.SupplierCode" Title="Supplier Code" />
                <PropertyColumn Property="supplier => supplier.SupplierName" Title="Supplier Name" />
                <PropertyColumn Property="supplier => supplier.Company" Title="Company" />
                <PropertyColumn Property="supplier => supplier.ContactPerson" Title="Contact Person" />
                <PropertyColumn Property="supplier => supplier.Email" Title="Country" />
                <PropertyColumn Property="supplier => supplier.PhoneNumber" Title="Country" />
                @if (IsAdminUser)
                {
                    <TemplateColumn CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" AriaLabel="Open user menu">
                                <MudMenuItem Label="Edit" href="@($"/purchase/suppliers/{context.Item.SupplierCode}")" />
                                <MudMenuItem Label="Delete" Class="red-text" OnClick="@(() => OpenDialogAsync(context.Item))" />
                            </MudMenu>
                        </CellTemplate>
                    </TemplateColumn>
                }
                <TemplateColumn CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudStack Row>
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="Supplier" />
            </PagerContent>
        </MudDataGrid>

    }

}

@code {
    string? searchString;

    MudDataGrid<Supplier> dataGrid = new();

    private IEnumerable<Supplier> _suppliers = new List<Supplier>();
    private IEnumerable<Supplier> _filteredsuppliers = new List<Supplier>();
    private ApplicationUser? CurrentUser { get; set; } // Replace ApplicationUser with your actual user class
    private bool IsAdminUser { get; set; }
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            CurrentUser = await UserManager.GetUserAsync(user);
            IsAdminUser = user.IsInRole("Administrator"); // Check if the user has the "Administrator" role
        }


        _suppliers = await SupplierService.GetAllSupplierAsync();
    }

    async Task OpenDialogAsync(Supplier supplier)
    {

        var parameters = new DialogParameters<DialogComponent>
        {
            {x => x.ContentText, $"Are you sure you want to delete the supplier '{supplier.SupplierName}'? This action cannot be undone."},
            { "Button1Text", "Confirm" },
            { "Button2Text", "Cancel" },
            { "Color", Color.Error }
        };

        var dialog = await DialogService.ShowAsync<DialogComponent>("Delete Supplier", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await SupplierService.DeleteSupplierAsync(supplier);
                Snackbar.Add("Supplier Deleted", Severity.Success);
                await dataGrid.ReloadServerData();

            }
            catch (InvalidOperationException ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
        }

    }

    void RowClicked(DataGridRowClickEventArgs<Supplier> args)
    {


        if (args.Item == null)
        {
            return;
        }

        NavigationManager.NavigateTo($"/purchase/suppliers/{args.Item.SupplierCode}");

    }

    private async Task<GridData<Supplier>> ServerReload(GridState<Supplier> state)
    {
        _suppliers = await SupplierService.GetAllSupplierAsync();

        _filteredsuppliers = _suppliers;


        _filteredsuppliers = _filteredsuppliers.Where(supplier =>
        {
            if (string.IsNullOrWhiteSpace(searchString))
                return true;
            if (supplier.SupplierCode.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return true;
            if (supplier.SupplierName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return true;
            if (supplier.Company.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return true;
            if (supplier.ContactPerson.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return true;
            if (supplier.Email.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return true;
            if (supplier.PhoneNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                return true;
            return false;
        }).ToArray();
        var totalItems = _filteredsuppliers.Count();

        var sortDefinition = state.SortDefinitions.FirstOrDefault();
        if (sortDefinition != null)
        {
            switch (sortDefinition.SortBy)
            {
                case nameof(Supplier.SupplierName):
                    _filteredsuppliers = _filteredsuppliers.OrderByDirection(
                        sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending,
                        o => o.SupplierName
                    );
                    break;
            }
        }

        var pagedData = _filteredsuppliers.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
        return new GridData<Supplier>
            {
                TotalItems = totalItems,
                Items = pagedData
            };
    }


    private Task OnSearch(string text)
    {
        searchString = text;
        return dataGrid.ReloadServerData();
    }
}
