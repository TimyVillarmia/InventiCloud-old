@page "/store/branches"
@using InventiCloud.Components.UI
@using InventiCloud.Data
@using InventiCloud.Services
@using InventiCloud.Services.Interface
@using InventiCloud.Entities
@inject IBranchService BranchService
@inject IBranchAccountService BranchAccountService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Branches</PageTitle>

<MudText Class="bold mb-2" Typo="Typo.h4">Branches</MudText>
@if (_branches == null)
{
    <MudContainer Class="d-flex justify-center align-items-center" Style="height: 50vh;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudContainer>
}
else
{
    @if (!_branches.Any())
    {
        <MudPaper Height="500px" Class="justify-center align-content-center">
            <MudText Class="bol" Typo="Typo.h6" Align="Align.Center">No Branches Found</MudText>
            <MudText Typo="Typo.body1" Align="Align.Center">
                Click the "Add Branch" button to create a new branch.
            </MudText>
            <MudContainer Class="d-flex justify-center mt-2">
                <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Href="/store/branches/create" Color="Color.Primary" Class="text-uppercase">
                    Add Branch
                </MudButton>
            </MudContainer>
        </MudPaper>

    }
    else
    {
        <MudGrid>
            <MudItem sm="6">
                <MudTextField T="string" ValueChanged="@(s=>OnSearchBranches(s))" Variant="Variant.Outlined" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            </MudItem>
            <MudItem sm="6" Class="d-flex justify-end align-items-center" Style="height:50%;">
                <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add" Href="/store/branches/create" Color="Color.Primary" Class="text-uppercase">
                    Add Branch
                </MudButton>
            </MudItem>
        </MudGrid>
        <MudDataGrid @ref="dataGridBranchAndAccount" T="CombinedBranchAccountViewModel" ServerData="ServerReloadBranches" RowClick="@RowClicked" EditMode="DataGridEditMode.Form">
            <Columns>
                <PropertyColumn Property="branch => branch.BranchName" Title="Branch Name" />
                <PropertyColumn Property="branch => branch.Address" Title="Location" />
                <PropertyColumn Property="branch => branch.PhoneNumber" Title="Phone Number" />
                <PropertyColumn Property="branch => branch.Email" Title="Email" />
                <TemplateColumn CellClass="d-flex justify-end">
                    <CellTemplate>
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" AriaLabel="Open user menu">
                            <MudMenuItem Label="Edit" href="@($"/store/branches/branch/{context.Item.BranchName}")" />
                            <MudMenuItem Label="Delete" Class="red-text" OnClick="@(() => OpenDialogBranchAsync(context.Item))" />

                        </MudMenu>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="CombinedBranchAccountViewModel" />
            </PagerContent>
        </MudDataGrid>

    }

}



@code {


    MudDataGrid<CombinedBranchAccountViewModel> dataGridBranchAndAccount = new();
    private string? searchStringBranch;

    private IEnumerable<Branch>? _branches;
    private IEnumerable<ApplicationUser>? _branchAccounts;
    private IEnumerable<CombinedBranchAccountViewModel>? _branchAndAccounts;

    public class CombinedBranchAccountViewModel
    {
        public string AccountId { get; set; }
        public string BranchName { get; set; }

        public string Address { get; set; }

        public string PhoneNumber { get; set; }
        public string Email { get; set; }
    }


    protected override async Task OnInitializedAsync()
    {

        await LoadData();

    }

    private async Task LoadData()
    {
        _branches = await BranchService.GetAllBranchAsync();
        _branchAccounts = await BranchAccountService.GetAllBranchAccountsAsync();
        _branchAndAccounts = await GetCombinedViewModel();
    }

    private async Task<IEnumerable<CombinedBranchAccountViewModel>> GetCombinedViewModel()
    {
        if (_branches == null)
        {
            return new List<CombinedBranchAccountViewModel>();
        }

        return _branches.Select(b => new CombinedBranchAccountViewModel
            {
                AccountId = _branchAccounts?.FirstOrDefault(ba => ba.BranchId == b.BranchId)?.Id,
                BranchName = b.BranchName,
                Address = b.Address,
                PhoneNumber = b.PhoneNumber,
                Email = _branchAccounts?.FirstOrDefault(ba => ba.BranchId == b.BranchId)?.Email
            }).ToList();
    }

    private async Task<GridData<CombinedBranchAccountViewModel>> ServerReloadBranches(GridState<CombinedBranchAccountViewModel> state)
    {

        await LoadData();

        _branchAndAccounts = _branchAndAccounts.Where(branch =>
        {
            if (string.IsNullOrWhiteSpace(searchStringBranch))
                return true;
            if (branch.BranchName.Contains(searchStringBranch, StringComparison.OrdinalIgnoreCase))
                return true;
            if (branch.Address.Contains(searchStringBranch, StringComparison.OrdinalIgnoreCase))
                return true;
            if (branch.PhoneNumber.Contains(searchStringBranch, StringComparison.OrdinalIgnoreCase))
                return true;
            if (branch.Email.Contains(searchStringBranch, StringComparison.OrdinalIgnoreCase))
                return true;
            return false;
        }).ToArray();
        var totalItems = _branchAndAccounts.Count();

        var sortDefinition = state.SortDefinitions.FirstOrDefault();
        if (sortDefinition != null)
        {
            switch (sortDefinition.SortBy)
            {
                case nameof(CombinedBranchAccountViewModel.BranchName):
                    _branches = _branches.OrderByDirection(
                        sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending,
                        b => b.BranchName
                    );
                    break;
            }
        }



        var pagedData = _branchAndAccounts.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
        return new GridData<CombinedBranchAccountViewModel>
            {
                TotalItems = totalItems,
                Items = pagedData
            };
    }




    void RowClicked(DataGridRowClickEventArgs<CombinedBranchAccountViewModel> args)
    {


        if (args.Item == null)
        {
            return;
        }


    }

    async Task OpenDialogBranchAsync(CombinedBranchAccountViewModel selectedRow)
    {
        var parameters = new DialogParameters<DialogComponent>
      {
          { x => x.ContentText, $"Are you sure you want to delete the branch '{selectedRow.BranchName}'? This action cannot be undone and will affect associated data." },
           { "Button1Text", "Delete" },
          { "Button2Text", "Cancel" },
          { "Color", Color.Error }
      };

        var dialog = await DialogService.ShowAsync<DialogComponent>("Delete Branch", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                // Assuming you have a BranchService injected
                var branch = await BranchService.GetBranchByNameAsync(selectedRow.BranchName);
                await BranchAccountService.DeleteBranchAccountAsync(selectedRow.AccountId);
                await BranchService.DeleteBranch(branch);
                Snackbar.Add($"Branch '{branch.BranchName}' deleted successfully.", Severity.Success);
                // Assuming you have a MudDataGrid named dataGridBranches
                await dataGridBranchAndAccount.ReloadServerData();
            }
            catch (InvalidOperationException ex)
            {
                Snackbar.Add(ex.Message, Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"An error occurred while deleting the branch '{selectedRow.BranchName}'.", Severity.Error);
            }
        }
    }

    private Task OnSearchBranches(string text)
    {
        searchStringBranch = text;
        return dataGridBranchAndAccount.ReloadServerData();
    }

}
