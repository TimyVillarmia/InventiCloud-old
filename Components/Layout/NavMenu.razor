@implements IDisposable
@using InventiCloud.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<MudNavMenu>
    <MudNavLink Href="/home" Match="NavLinkMatch.All" Icon="@Icons.Material.Outlined.Home">Home</MudNavLink>

    <MudNavGroup Title="Products" Expanded="true" Icon="@Icons.Material.Outlined.Inventory2">
        <MudNavLink Href="products" Match="NavLinkMatch.Prefix">Product List</MudNavLink>
        <MudNavLink Href="product-setup/categories" Match="NavLinkMatch.Prefix">Categories</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Inventory" Expanded="true" Icon="@Icons.Material.Outlined.Warehouse">
        <MudNavLink Href="inventory/stock-levels" Match="NavLinkMatch.Prefix">Stock Levels</MudNavLink>
        <MudNavGroup Title="Stock Transfers" Expanded="true">
            @if (IsAdminUser)
            {
                <MudNavLink Href="inventory/stock-transfers/all" Match="NavLinkMatch.Prefix">All Stock Transfers</MudNavLink>

            }
            else
            {
                <MudNavLink Href="inventory/stock-transfers/requests" Match="NavLinkMatch.Prefix">My Requests</MudNavLink>
                <MudNavLink Href="inventory/stock-transfers/approvals" Match="NavLinkMatch.Prefix">My Approvals</MudNavLink>


            }
        </MudNavGroup>
        <MudNavLink Href="inventory/stock-adjustments" Match="NavLinkMatch.Prefix">Stock Adjustments</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Purchases" Expanded="true" Icon="@Icons.Material.Outlined.LocalShipping">
        <MudNavLink Href="purchase/orders" Match="NavLinkMatch.Prefix">Purchase Orders</MudNavLink>
        <MudNavLink Href="purchase/suppliers" Match="NavLinkMatch.Prefix">Suppliers</MudNavLink>
    </MudNavGroup>

    <MudNavGroup Title="Sales" Expanded="true" Icon="@Icons.Material.Outlined.ShoppingCart">
        <MudNavLink Href="sales/orders" Match="NavLinkMatch.Prefix">Sales Orders</MudNavLink>
        <MudNavLink Href="sales/customers" Match="NavLinkMatch.Prefix">Customers</MudNavLink>
    </MudNavGroup>
    <AuthorizeView Roles="Administrator">
        <MudNavGroup Title="Store" Expanded="true" Icon="@Icons.Material.Outlined.Storefront">
            <MudNavLink Href="store/branches" Match="NavLinkMatch.Prefix">Branches</MudNavLink>
            <MudNavLink Href="store/sales-persons" Match="NavLinkMatch.Prefix">Sales Person</MudNavLink>
        </MudNavGroup>
    </AuthorizeView>

    <MudDivider Class="my-2" />
    <MudNavLink Icon="@Icons.Material.Outlined.Logout" IconColor="Color.Error" Class="red-text" OnClick="Logout">Logout</MudNavLink>

</MudNavMenu>



@code {
    private string? currentUrl;
    private bool IsAdminUser { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;


        if (user.Identity?.IsAuthenticated == true)
        {
            IsAdminUser = user.IsInRole("Administrator"); // Check if the user has the "Administrator" role
        }
    }

    protected override void OnInitialized()
    {



        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;




    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private async Task Logout()
    {

        NavigationManager.NavigateTo("/Account/Logout", true); // Assuming you have an Account/Logout endpoint
    }
  

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}


